# ============================================
# Squid 高性能生产配置
# 适用于：大流量、多用户生产环境（动态IP环境）
# 服务器：154.12.95.232
# 端口：3128
# ============================================

# 1. 网络配置
# --------------------------------------------
# 监听端口
http_port 3128

# 如果需要透明代理，使用以下配置
# http_port 3128 intercept

# 2. 用户认证（可选）
# --------------------------------------------
# 如果需要认证，取消注释以下行
# auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwords
# auth_param basic children 10
# auth_param basic realm Squid Proxy Server
# auth_param basic credentialsttl 2 hours
# acl authenticated proxy_auth REQUIRED

# 3. 访问控制列表（ACL）
# --------------------------------------------
# 定义允许的客户端IP（根据实际情况修改）
acl localnet src 10.0.0.0/8
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16

# 允许所有IP访问（因为本地是动态IP）
# ⚠️ 生产环境建议启用认证或配合防火墙限制访问
acl all_clients src 0.0.0.0/0

# 如果本地IP固定，可以改为限制特定IP（更安全）：
# acl allowed_clients src 您的本地公网IP/32
# http_access allow allowed_clients

# 定义安全端口
acl SSL_ports port 443
acl Safe_ports port 80 21 443 70 210 1025-65535 280 488 591 777

acl CONNECT method CONNECT

# 时间ACL（可选：限制工作时间使用）
# acl working_hours time MTWHF 09:00-18:00

# 4. 访问控制规则
# --------------------------------------------
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

http_access allow localhost manager
http_access deny manager

http_access allow localhost

# 根据实际需求选择以下之一：
# 选项1：允许特定IP（推荐）
# http_access allow allowed_clients

# 选项2：需要认证
# http_access allow authenticated

# 选项3：允许所有（仅测试环境）
http_access allow all_clients

# 时间限制（可选）
# http_access allow authenticated working_hours
# http_access deny all

http_access deny all

# 5. 高级缓存配置
# --------------------------------------------
# 缓存目录（500MB，建议根据磁盘空间调整）
cache_dir ufs /var/spool/squid 500 16 256

# 内存缓存（建议至少256MB）
cache_mem 512 MB

# 对象大小限制
maximum_object_size 10 MB
maximum_object_size_in_memory 512 KB
minimum_object_size 0 KB

# 缓存替换策略
cache_replacement_policy heap LFUDA
memory_replacement_policy heap GDSF

# 6. 性能优化
# --------------------------------------------
# DNS服务器
dns_nameservers 8.8.8.8 8.8.4.4 1.1.1.1

# 网络优化
tcp_outgoing_address 0.0.0.0
tcp_recv_bufsize 64 KB

# 连接池
pconn_timeout 120 seconds

# 并发连接数
max_filedescriptors 4096

# 7. 刷新规则（缓存策略）
# --------------------------------------------
# 动态内容不缓存
refresh_pattern -i (/cgi-bin/|\?) 0 0% 0

# 静态内容缓存
refresh_pattern -i \.(jpg|jpeg|png|gif|bmp|ico)$ 1440 90% 10080
refresh_pattern -i \.(css|js)$ 1440 40% 10080
refresh_pattern -i \.(html|htm)$ 1440 40% 40320
refresh_pattern -i \.(mp3|mp4|avi|mov|mkv)$ 10080 90% 43200

# FTP
refresh_pattern ^ftp: 1440 20% 10080

# 默认
refresh_pattern . 0 20% 4320

# 8. 日志配置
# --------------------------------------------
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
cache_store_log none  # 禁用store.log以提高性能

# 日志轮转
logfile_rotate 10

# 9. 安全配置
# --------------------------------------------
# 隐藏版本信息
httpd_suppress_version_string on

# X-Forwarded-For头
forwarded_for on

# 隐藏内部网络结构（可选）
# request_header_access Via deny all
# request_header_access X-Forwarded-For deny all

# 防止缓存敏感信息
acl password_url urlpath_regex -i \/login \/password \/signin \/auth
cache deny password_url

# 10. 超时配置
# --------------------------------------------
connect_timeout 30 seconds
read_timeout 5 minutes
request_timeout 5 minutes
persistent_request_timeout 2 minutes

# 11. 其他配置
# --------------------------------------------
visible_hostname proxy-prod-154.12.95.232
coredump_dir /var/spool/squid

# 错误页面语言
error_directory /usr/share/squid/errors/zh-cn

# 关闭不必要的功能
via off

