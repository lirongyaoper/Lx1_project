# ============================================
# Squid 安全认证配置文件
# 适用于：需要用户名密码认证的代理（动态IP环境）
# 服务器：154.12.95.232
# 端口：3128
# ============================================

# 1. 网络配置
# --------------------------------------------
http_port 3128

# 2. 用户认证配置
# --------------------------------------------
# 使用基本认证
auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwords
auth_param basic children 5
auth_param basic realm Squid Proxy Server
auth_param basic credentialsttl 2 hours
auth_param basic casesensitive on

# 3. 访问控制列表（ACL）定义
# --------------------------------------------
# 定义认证用户
acl authenticated proxy_auth REQUIRED

# 定义安全端口
acl SSL_ports port 443
acl Safe_ports port 80              # http
acl Safe_ports port 21              # ftp
acl Safe_ports port 443             # https
acl Safe_ports port 70              # gopher
acl Safe_ports port 210             # wais
acl Safe_ports port 1025-65535      # 未注册端口
acl Safe_ports port 280             # http-mgmt
acl Safe_ports port 488             # gss-http
acl Safe_ports port 591             # filemaker
acl Safe_ports port 777             # multiling http

acl CONNECT method CONNECT

# 黑名单域名（可选）
# acl blocked_sites dstdomain .facebook.com .twitter.com
# acl blocked_ips dst 1.2.3.4

# 4. 访问控制规则
# --------------------------------------------
# 拒绝不安全端口
http_access deny !Safe_ports

# 拒绝CONNECT到非SSL端口
http_access deny CONNECT !SSL_ports

# 允许本地管理
http_access allow localhost manager
http_access deny manager

# 允许本地访问（无需认证）
http_access allow localhost

# 拒绝黑名单（可选）
# http_access deny blocked_sites
# http_access deny blocked_ips

# 要求认证后才能访问
http_access allow authenticated

# 拒绝其他所有访问
http_access deny all

# 5. 缓存配置
# --------------------------------------------
cache_dir ufs /var/spool/squid 100 16 256
cache_mem 256 MB
maximum_object_size 4 MB
minimum_object_size 0 KB

# 6. 日志配置
# --------------------------------------------
access_log /var/log/squid/access.log squid
cache_log /var/log/squid/cache.log
cache_store_log /var/log/squid/store.log

# 日志格式（包含用户名）
logformat combined %>a %[ui %[un [%tl] "%rm %ru HTTP/%rv" %>Hs %<st "%{Referer}>h" "%{User-Agent}>h" %Ss:%Sh

# 7. 性能优化
# --------------------------------------------
dns_nameservers 8.8.8.8 8.8.4.4

refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

# 8. 安全增强
# --------------------------------------------
# 隐藏Squid版本信息
httpd_suppress_version_string on

# 隐藏客户端IP（可选）
forwarded_for on
# forwarded_for off  # 完全隐藏客户端IP

# 9. 其他配置
# --------------------------------------------
visible_hostname proxy-auth-154.12.95.232
coredump_dir /var/spool/squid

# 连接超时
connect_timeout 1 minute
read_timeout 15 minutes
request_timeout 5 minutes

